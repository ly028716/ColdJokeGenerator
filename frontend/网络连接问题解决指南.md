# 微信小程序网络连接问题解决指南

## 🚨 问题描述
微信小程序出现以下错误：
```
API请求失败: /admin/health {errMsg: "request:fail timeout", errno: undefined}
网络检查失败: {type: "network", code: -1, message: "网络连接失败，请检查网络设置"}
```

## 🔧 解决方案

### 步骤1：微信开发者工具设置（必须操作）

#### 1.1 打开详情面板
- 在微信开发者工具中，点击右上角的 **"详情"** 按钮

#### 1.2 本地设置配置
在 **"本地设置"** 标签页中，**必须勾选**以下选项：
- ✅ **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**
- ✅ **开启调试模式**
- ✅ **启用热重载**（可选，提升开发体验）

#### 1.3 项目设置确认
在 **"项目设置"** 标签页中，确认：
- ✅ **不校验合法域名** 已开启
- ✅ **不校验 HTTPS 证书** 已开启

### 步骤2：确认后端服务状态

#### 2.1 检查后端服务
确保后端服务正在运行：
```bash
# 在 backend 目录下运行
python simple_server.py
```

#### 2.2 测试后端接口
在浏览器或命令行中测试：
```bash
# 健康检查
curl http://localhost:8000/health

# API测试
curl http://localhost:8000/api/test

# 笑话生成测试
curl -X POST http://localhost:8000/api/v1/jokes/generate \
  -H "Content-Type: application/json" \
  -d '{"category":"科技","style":"幽默"}'
```

### 步骤3：代码优化（已完成）

#### 3.1 API超时时间调整
- 将默认超时时间从10秒增加到15秒
- 健康检查超时时间设置为8秒

#### 3.2 错误处理优化
- 添加了更详细的网络状态检查
- 实现了多级API连接测试
- 优化了错误日志输出

#### 3.3 新增测试接口
- 添加了 `testConnection()` 方法
- 优化了健康检查逻辑

### 步骤4：重启和测试

#### 4.1 重启开发者工具
1. 关闭微信开发者工具
2. 重新打开项目
3. 确认设置已保存

#### 4.2 清除缓存
在开发者工具中：
- 点击 **"清缓存"** → **"清除全部缓存"**

#### 4.3 重新编译
- 点击 **"编译"** 按钮重新编译项目

## 🔍 故障排查

### 如果仍然无法连接：

#### 检查1：防火墙设置
确保Windows防火墙允许端口8000的访问：
```powershell
# 检查端口是否被占用
netstat -ano | findstr :8000

# 添加防火墙规则（以管理员身份运行）
netsh advfirewall firewall add rule name="Python Server" dir=in action=allow protocol=TCP localport=8000
```

#### 检查2：网络代理
如果使用了代理软件，请：
- 关闭代理软件
- 或在代理软件中添加localhost例外

#### 检查3：端口冲突
如果8000端口被占用，修改后端服务端口：
```python
# 在 simple_server.py 中修改
if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8001)  # 改为8001
```

然后更新前端API地址：
```javascript
// 在 app.js 中修改
this.globalData.apiUrl = "http://localhost:8001/api/v1";
```

## ✅ 验证成功

当设置正确后，你应该看到：
1. 控制台输出：`API连接正常` 或 `健康检查通过`
2. 小程序能够正常生成笑话
3. 统计数据正常更新

## 📞 技术支持

如果按照以上步骤仍然无法解决问题，请提供：
1. 微信开发者工具版本号
2. 详细的错误日志
3. 网络环境信息（是否使用代理等）

---

**重要提醒**：在正式发布小程序时，需要配置合法的HTTPS域名，localhost仅适用于开发环境。